<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestaurantOwnerService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">restaurant</a> &gt; <a href="index.source.html" class="el_package">com.food.restaurant.service</a> &gt; <span class="el_source">RestaurantOwnerService.java</span></div><h1>RestaurantOwnerService.java</h1><pre class="source lang-java linenums">package com.food.restaurant.service;

import com.food.restaurant.constant.Constants;
import com.food.restaurant.dto.ForgotPasswordDTO;
import com.food.restaurant.dto.LoginDTO;
import com.food.restaurant.dto.RestaurantOutDTO;
import com.food.restaurant.dto.RestaurantOwnerInDTO;
import com.food.restaurant.dto.RestaurantOwnerOutDTO;
import com.food.restaurant.dto.RestaurantOwnerUpdateDTO;
import com.food.restaurant.entity.Restaurant;
import com.food.restaurant.entity.RestaurantOwner;
import com.food.restaurant.exception.ResourceAlreadyExistException;
import com.food.restaurant.exception.ResourceNotFoundException;
import com.food.restaurant.repository.RestaurantOwnerRepository;
import com.food.restaurant.repository.RestaurantRepository;
import com.food.restaurant.util.MessageDTO;
import com.food.restaurant.util.PasswordUtil;
import com.food.restaurant.util.RestaurantMapper;
import jakarta.transaction.Transactional;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Service class for managing restaurant owners.
 * Provides functionality to create, update, delete, and retrieve restaurant owner information.
 * Also supports login, password reset, and retrieving restaurants associated with an owner.
 * Uses SLF4J for logging and JavaMailSender for sending emails.
 */
@Service
<span class="fc" id="L39">@Slf4j</span>
<span class="fc" id="L40">public class RestaurantOwnerService {</span>

  @Autowired
  private RestaurantOwnerRepository ownerRepository;

  @Autowired
  private RestaurantMapper restaurantMapper;

  @Autowired
  private RestaurantRepository restaurantRepository;

  @Autowired
  private JavaMailSender javaMailSender;

  /**
   * Creates a new restaurant owner.
   * Checks if the email already exists and throws an exception if it does.
   * Encrypts the owner's password before saving.
   *
   * @param ownerDto the DTO containing restaurant owner information to be created
   * @return ResponseEntity containing a message DTO and HTTP status code
   */
  public ResponseEntity&lt;MessageDTO&gt; createRestaurantOwner(RestaurantOwnerInDTO ownerDto) {
<span class="fc" id="L63">    log.info(&quot;Entering createRestaurantOwner with email: {}&quot;, ownerDto.getEmail());</span>
<span class="fc" id="L64">    String trimmedEmail = ownerDto.getEmail().trim().toLowerCase();</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">    if (ownerRepository.existsByEmail(trimmedEmail)) {</span>
<span class="fc" id="L66">      log.warn(&quot;Email already exists: {}&quot;, ownerDto.getEmail());</span>
<span class="fc" id="L67">      throw new ResourceAlreadyExistException(Constants.EMAIL_ALREADY_EXISTS);</span>
    }

<span class="fc" id="L70">    ownerDto.setPassword(PasswordUtil.encode(ownerDto.getPassword()));</span>
<span class="fc" id="L71">    RestaurantOwner owner = restaurantMapper.toEntity(ownerDto);</span>
<span class="fc" id="L72">    ownerRepository.save(owner);</span>

<span class="fc" id="L74">    log.info(&quot;Exiting createRestaurantOwner with email: {}&quot;, ownerDto.getEmail());</span>
<span class="fc" id="L75">    return new ResponseEntity&lt;&gt;(new MessageDTO(Constants.RESTAURANT_OWNER_CREATED_SUCCESSFULLY), HttpStatus.CREATED);</span>
  }

  /**
   * Updates an existing restaurant owner's details.
   * Throws an exception if the owner is not found.
   *
   * @param id       the ID of the restaurant owner to be updated
   * @param ownerDto the DTO containing updated restaurant owner information
   * @return ResponseEntity containing a message DTO and HTTP status code
   */
  public ResponseEntity&lt;MessageDTO&gt; updateRestaurantOwner(Long id, RestaurantOwnerUpdateDTO ownerDto) {
<span class="fc" id="L87">    log.info(&quot;Entering updateRestaurantOwner with id: {} and email: {}&quot;, id, ownerDto.getEmail());</span>

<span class="fc" id="L89">    Optional&lt;RestaurantOwner&gt; existingOwner = ownerRepository.findById(id);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">    if (existingOwner.isEmpty()) {</span>
<span class="fc" id="L91">      log.warn(&quot;Restaurant owner not found with id: {}&quot;, id);</span>
<span class="fc" id="L92">      throw new ResourceNotFoundException(Constants.RESOURCE_NOT_FOUND);</span>
    }

<span class="fc" id="L95">    RestaurantOwner owner = existingOwner.get();</span>
<span class="fc" id="L96">    owner.setFirstName(ownerDto.getFirstName());</span>
<span class="fc" id="L97">    owner.setLastName(ownerDto.getLastName());</span>
<span class="fc" id="L98">    owner.setEmail(ownerDto.getEmail());</span>
<span class="fc" id="L99">    owner.setContactNumber(ownerDto.getContactNumber());</span>
//    owner.setPassword(PasswordUtil.encode(ownerDto.getPassword()));
<span class="fc" id="L101">    ownerRepository.save(owner);</span>

<span class="fc" id="L103">    log.info(&quot;Exiting updateRestaurantOwner with id: {}&quot;, id);</span>
<span class="fc" id="L104">    return new ResponseEntity&lt;&gt;(new MessageDTO(Constants.RESTAURANT_OWNER_UPDATED_SUCCESSFULLY), HttpStatus.OK);</span>
  }

  /**
   * Deletes a restaurant owner by their ID.
   * Returns a not found status if the owner does not exist.
   *
   * @param id the ID of the restaurant owner to be deleted
   * @return ResponseEntity containing a message DTO and HTTP status code
   */
  public ResponseEntity&lt;MessageDTO&gt; deleteRestaurantOwner(Long id) {
<span class="fc" id="L115">    log.info(&quot;Entering deleteRestaurantOwner with id: {}&quot;, id);</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">    if (!ownerRepository.existsById(id)) {</span>
<span class="fc" id="L118">      log.warn(&quot;Restaurant owner not found with id: {}&quot;, id);</span>
<span class="fc" id="L119">      return new ResponseEntity&lt;&gt;(new MessageDTO(Constants.RESOURCE_NOT_FOUND), HttpStatus.NOT_FOUND);</span>
    }

<span class="fc" id="L122">    ownerRepository.deleteById(id);</span>
<span class="fc" id="L123">    log.info(&quot;Exiting deleteRestaurantOwner with id: {}&quot;, id);</span>
<span class="fc" id="L124">    return new ResponseEntity&lt;&gt;(new MessageDTO(Constants.RESTAURANT_OWNER_DELETED_SUCCESSFULLY), HttpStatus.OK);</span>
  }

  /**
   * Retrieves a restaurant owner by their ID.
   * Returns a not found status if the owner does not exist.
   *
   * @param id the ID of the restaurant owner to be retrieved
   * @return ResponseEntity containing the restaurant owner DTO and HTTP status code
   */
  public ResponseEntity&lt;RestaurantOwnerOutDTO&gt; getRestaurantOwner(Long id) {
<span class="fc" id="L135">    log.info(&quot;Entering getRestaurantOwner with id: {}&quot;, id);</span>

<span class="fc" id="L137">    Optional&lt;RestaurantOwner&gt; owner = ownerRepository.findById(id);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">    if (owner.isEmpty()) {</span>
<span class="fc" id="L139">      log.warn(&quot;Restaurant owner not found with id: {}&quot;, id);</span>
<span class="fc" id="L140">      return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
    }

<span class="fc" id="L143">    RestaurantOwnerOutDTO ownerDto = restaurantMapper.toDto(owner.get());</span>
<span class="fc" id="L144">    log.info(&quot;Exiting getRestaurantOwner with id: {}&quot;, id);</span>
<span class="fc" id="L145">    return new ResponseEntity&lt;&gt;(ownerDto, HttpStatus.OK);</span>
  }

  /**
   * Retrieves all restaurant owners.
   *
   * @return ResponseEntity containing a list of restaurant owner DTOs and HTTP status code
   */
  public ResponseEntity&lt;List&lt;RestaurantOwnerOutDTO&gt;&gt; getAllRestaurantOwners() {
<span class="fc" id="L154">    log.info(&quot;Entering getAllRestaurantOwners&quot;);</span>

<span class="fc" id="L156">    List&lt;RestaurantOwner&gt; owners = ownerRepository.findAll();</span>
<span class="fc" id="L157">    List&lt;RestaurantOwnerOutDTO&gt; ownerDtos = owners.stream()</span>
<span class="fc" id="L158">      .map(restaurantMapper::toDto)</span>
<span class="fc" id="L159">      .toList();</span>

<span class="fc" id="L161">    log.info(&quot;Exiting getAllRestaurantOwners&quot;);</span>
<span class="fc" id="L162">    return new ResponseEntity&lt;&gt;(ownerDtos, HttpStatus.OK);</span>
  }

  /**
   * Logs in a restaurant owner.
   * Checks the email and password, and returns owner details if login is successful.
   * Throws exceptions for incorrect credentials or non-existent email.
   *
   * @param loginDto the DTO containing email and password for login
   * @return ResponseEntity containing the restaurant owner DTO and HTTP status code
   */
  public ResponseEntity&lt;RestaurantOwnerOutDTO&gt; login(LoginDTO loginDto) {
<span class="fc" id="L174">    log.info(&quot;Entering login with email: {}&quot;, loginDto.getEmail());</span>

<span class="fc" id="L176">    Optional&lt;RestaurantOwner&gt; ownerOpt = ownerRepository.findByEmail(loginDto.getEmail());</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">    if (ownerOpt.isEmpty()) {</span>
<span class="fc" id="L178">      log.warn(&quot;Login failed, email not found: {}&quot;, loginDto.getEmail());</span>
<span class="fc" id="L179">      throw new ResourceNotFoundException(Constants.EMAIL_NOT_FOUND);</span>
    }

<span class="fc" id="L182">    RestaurantOwner owner = ownerOpt.get();</span>
<span class="fc" id="L183">    String decodedPassword = PasswordUtil.decode(owner.getPassword());</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">    if (!decodedPassword.equals(loginDto.getPassword())) {</span>
<span class="fc" id="L185">      log.warn(&quot;Login failed, password mismatch for email: {}&quot;, loginDto.getEmail());</span>
<span class="fc" id="L186">      throw new ResourceNotFoundException(Constants.INCORRECT_PASSWORD);</span>
    }

<span class="fc" id="L189">    log.info(&quot;Login successful for email: {}&quot;, loginDto.getEmail());</span>

<span class="fc" id="L191">    RestaurantOwnerOutDTO ownerOutDTO = new RestaurantOwnerOutDTO();</span>
<span class="fc" id="L192">    ownerOutDTO.setId(owner.getId());</span>
<span class="fc" id="L193">    ownerOutDTO.setFirstName(owner.getFirstName());</span>
<span class="fc" id="L194">    ownerOutDTO.setLastName(owner.getLastName());</span>
<span class="fc" id="L195">    ownerOutDTO.setEmail(owner.getEmail());</span>
<span class="fc" id="L196">    ownerOutDTO.setContactNumber(owner.getContactNumber());</span>

<span class="fc" id="L198">    return new ResponseEntity&lt;&gt;(ownerOutDTO, HttpStatus.OK);</span>
  }

  /**
   * Retrieves all restaurants associated with a specific owner.
   * Throws an exception if no restaurants are found for the given owner ID.
   *
   * @param ownerId the ID of the restaurant owner whose restaurants are to be retrieved
   * @return ResponseEntity containing a list of restaurant DTOs and HTTP status code
   */
  @Transactional
  public ResponseEntity&lt;List&lt;RestaurantOutDTO&gt;&gt; getRestaurantsByOwnerId(Long ownerId) {
<span class="fc" id="L210">    log.info(&quot;Entering getRestaurantsByOwnerId with ownerId: {}&quot;, ownerId);</span>

<span class="fc" id="L212">    List&lt;Restaurant&gt; restaurants = restaurantRepository.findByRestaurantOwnerId(ownerId);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">    if (restaurants.isEmpty()) {</span>
<span class="fc" id="L214">      log.warn(&quot;No restaurants found for ownerId: {}&quot;, ownerId);</span>
<span class="fc" id="L215">      throw new ResourceNotFoundException(Constants.NO_RESTAURANTS_FOUND_FOR_OWNER);</span>
    }
<span class="fc" id="L217">    List&lt;RestaurantOutDTO&gt; restaurantOutDTOs = restaurants.stream()</span>
<span class="fc" id="L218">      .map(this::toOutDTO)</span>
<span class="fc" id="L219">      .collect(Collectors.toList());</span>

<span class="fc" id="L221">    log.info(&quot;Exiting getRestaurantsByOwnerId with ownerId: {}&quot;, ownerId);</span>
<span class="fc" id="L222">    return new ResponseEntity&lt;&gt;(restaurantOutDTOs, HttpStatus.OK);</span>
  }

  /**
   * Handles forgot password requests by sending an email with the current password.
   * Throws an exception if the email is not found.
   *
   * @param forgotPasswordDTO the DTO containing the email for which the password needs to be sent
   */
  public void forgotPassword(ForgotPasswordDTO forgotPasswordDTO) {
<span class="fc" id="L232">    log.info(&quot;Processing forgot password for email: {}&quot;, forgotPasswordDTO.getEmail());</span>
<span class="fc" id="L233">    RestaurantOwner owner = ownerRepository.findByEmail(forgotPasswordDTO.getEmail())</span>
<span class="fc" id="L234">      .orElseThrow(() -&gt; {</span>
<span class="fc" id="L235">        log.warn(&quot;Email not found&quot;);</span>
<span class="fc" id="L236">        return new ResourceNotFoundException(Constants.EMAIL_NOT_FOUND);</span>
      });

<span class="fc" id="L239">    String decryptedPassword = PasswordUtil.decode(owner.getPassword());</span>

<span class="fc" id="L241">    sendForgotPasswordEmail(owner.getEmail(), decryptedPassword);</span>
<span class="fc" id="L242">    log.info(&quot;Forgot password email sent successfully&quot;);</span>
<span class="fc" id="L243">  }</span>

  /**
   * Sends a forgot password email to the specified address.
   *
   * @param email    the recipient's email address
   * @param password the password to be sent
   */
  private void sendForgotPasswordEmail(String email, String password) {
<span class="fc" id="L252">    log.info(&quot;Sending forgot password email to: {}&quot;, email);</span>

<span class="fc" id="L254">    SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="fc" id="L255">    message.setTo(email);</span>
<span class="fc" id="L256">    message.setSubject(&quot;Forgot Password&quot;);</span>
<span class="fc" id="L257">    message.setText(&quot;Your password is: &quot; + password);</span>

<span class="fc" id="L259">    javaMailSender.send(message);</span>
<span class="fc" id="L260">  }</span>

  /**
   * Converts a Restaurant entity to a RestaurantOutDTO.
   *
   * @param restaurant the Restaurant entity to be converted
   * @return the corresponding RestaurantOutDTO
   */
  RestaurantOutDTO toOutDTO(Restaurant restaurant) {
<span class="fc" id="L269">    RestaurantOutDTO dto = new RestaurantOutDTO();</span>
<span class="fc" id="L270">    dto.setId(restaurant.getId());</span>
<span class="fc" id="L271">    dto.setEmail(restaurant.getEmail());</span>
<span class="fc" id="L272">    dto.setContactNumber(restaurant.getContactNumber());</span>
<span class="fc" id="L273">    dto.setName(restaurant.getName());</span>
<span class="fc" id="L274">    dto.setAddress(restaurant.getAddress());</span>
<span class="fc" id="L275">    dto.setTimings(restaurant.getTimings());</span>
<span class="fc" id="L276">    dto.setIsOpen(restaurant.getIsOpen());</span>
<span class="fc" id="L277">    dto.setImage(restaurant.getImage());</span>
<span class="fc" id="L278">    return dto;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>